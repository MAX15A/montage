

<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï½œå‡ºå¼µå–ã‚Šä»˜ã‘ã‚µãƒ¼ãƒ“ã‚¹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="é¡§å®¢ãƒ»è»Šä¸¡ãƒ»äºˆç´„ãƒ»è«‹æ±‚ã®ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã€‚æ¤œç´¢ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã€è«‹æ±‚ä½œæˆã€CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¯¾å¿œã€‚">
  <style>
    :root {
      --bg: #0f172a; --surface: #111827; --card: #1f2937; --text: #e5e7eb; --muted: #94a3b8;
      --accent: #3b82f6; --accent2: #ef4444; --ok: #22c55e; --warn: #f59e0b;
      --radius: 14px; --radius-lg: 22px; --shadow: 0 12px 28px rgba(0,0,0,0.35);
      --maxw: 1200px;
    }
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--text); }
    body { font-family: system-ui, -apple-system, "Noto Sans JP", Meiryo, sans-serif; line-height:1.6; }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .container { width: 100%; max-width: var(--maxw); margin: 0 auto; padding: 0 20px; }

    header { position: sticky; top:0; z-index:50; background: rgba(17,24,39,0.85); backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(255,255,255,0.08); }
    .nav { display:flex; justify-content:space-between; align-items:center; padding:14px 20px; }
    .brand { display:flex; align-items:center; gap:12px; font-weight:700; }
    .logo { width:36px; height:36px; display:grid; place-items:center; border-radius:8px;
      background: linear-gradient(135deg,#2563eb,#3b82f6); box-shadow: var(--shadow); }
    .tabs { display:flex; gap:8px; flex-wrap:wrap; }
    .tab { padding:8px 12px; border-radius:999px; background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12); cursor:pointer; }
    .tab.active { background: linear-gradient(135deg,#2563eb,#3b82f6); border:none; font-weight:700; }

    section { padding: 26px 0; }
    .card { background: var(--card); border: 1px solid rgba(255,255,255,0.08); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow); }
    .section-head { display:flex; justify-content:space-between; align-items:flex-end; gap:12px; margin-bottom:12px; }
    .section-head h2 { margin:0; font-size: clamp(22px,3.4vw,30px); }
    .section-head p { color:var(--muted); margin:6px 0 0; }

    .grid { display:grid; gap:14px; grid-template-columns: repeat(12, 1fr); }
    .col-12 { grid-column: span 12; }
    .col-6 { grid-column: span 6; }
    .col-4 { grid-column: span 4; }
    @media (max-width: 900px) { .col-6, .col-4 { grid-column: span 12; } }

    .metrics { display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; }
    @media (max-width: 900px) { .metrics { grid-template-columns: 1fr 1fr; } }
    .metric { background:#111b2a; border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:14px; }
    .metric .label { color:var(--muted); font-size:13px; }
    .metric .value { font-size:24px; font-weight:800; letter-spacing:0.3px; }

    .toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:8px; }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:8px 12px;
      border-radius:8px; border:1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.06); color:var(--text);
      cursor:pointer; transition: transform .12s ease, background .2s ease; }
    .btn:hover { transform: translateY(-1px); background: rgba(255,255,255,0.1); }
    .btn.primary { background: linear-gradient(135deg,#2563eb,#3b82f6); border:none; color:#fff; font-weight:700; }
    .btn.warn { background: #3b2f10; border-color: #f59e0b; color:#f59e0b; }
    .btn.danger { background: #2a1114; border-color: #ef4444; color:#ef4444; }

    input, select, textarea {
      padding: 10px 12px; background:#0b1220; color:var(--text); border:1px solid rgba(255,255,255,0.1);
      border-radius:10px; outline:none; transition:border-color .2s ease, box-shadow .2s ease;
    }
    input:focus, select:focus, textarea:focus { border-color: rgba(59,130,246,0.6); box-shadow: 0 0 0 4px rgba(59,130,246,0.15); }
    .table-wrap { overflow:auto; border:1px solid rgba(255,255,255,0.08); border-radius:12px; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.06); font-size: 14px; vertical-align: top; }
    th { text-align:left; color:#cbd5e1; background: rgba(255,255,255,0.04); position: sticky; top:0; }
    tr:hover td { background: rgba(255,255,255,0.03); }

    .status { padding:4px 8px; border-radius:999px; font-size:12px; display:inline-block; }
    .st-new { background:#293042; color:#cbd5e1; }
    .st-confirmed { background:#133a7a; color:#cbd5e1; }
    .st-onroute { background:#3b2a10; color:#f59e0b; }
    .st-working { background:#2f3b10; color:#f59e0b; }
    .st-done { background:#0f3a1a; color:#22c55e; }
    .st-invoiced { background:#312e52; color:#cbd5e1; }
    .st-unpaid { background:#3a1114; color:#ef4444; }
    .st-paid { background:#0f3a1a; color:#22c55e; }

    .muted { color:var(--muted); font-size:13px; }
    .hidden { display:none; }
    .toast { position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
      background: rgba(17,24,39,0.9); border:1px solid rgba(255,255,255,0.12); color:#cbd5e1; padding:10px 14px;
      border-radius: 999px; box-shadow: var(--shadow); z-index:9999; }
  </style>
</head>
<body>
<header>
  <div class="nav container">
    <div class="brand"><div class="logo">ğŸ› ï¸</div><div>ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div></div>
    <div class="tabs">
      <div class="tab active" data-pane="dashboard">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
      <div class="tab" data-pane="customers">é¡§å®¢</div>
      <div class="tab" data-pane="reservations">äºˆç´„</div>
      <div class="tab" data-pane="invoices">è«‹æ±‚</div>
      <div class="tab" data-pane="settings">è¨­å®š</div>
    </div>
  </div>
</header>

<main>
  <section id="dashboard" class="pane container">
    <div class="section-head">
      <h2>æ¦‚è¦</h2>
      <p>ä»Šæ—¥ãƒ»ä»Šé€±ã®å‹•ãã‚„æœªå¯¾å¿œä»¶æ•°ã®æŠŠæ¡ã«ã€‚</p>
    </div>
    <div class="metrics" id="metrics">
      <div class="metric"><div class="label">ä»Šæ—¥ã®äºˆç´„</div><div class="value" id="m_today">â€”</div></div>
      <div class="metric"><div class="label">æœªå¯¾å¿œï¼ˆæ–°è¦ï¼‰</div><div class="value" id="m_new">â€”</div></div>
      <div class="metric"><div class="label">æœªè«‹æ±‚</div><div class="value" id="m_uninvoiced">â€”</div></div>
      <div class="metric"><div class="label">æœªå…¥é‡‘</div><div class="value" id="m_unpaid">â€”</div></div>
    </div>
    <div style="margin-top:12px;" class="muted">æ›´æ–°ï¼š<span id="m_updated">â€”</span></div>
  </section>

  <section id="customers" class="pane container hidden">
    <div class="section-head">
      <h2>é¡§å®¢ç®¡ç†</h2>
      <div class="toolbar">
        <input id="custSearch" placeholder="æ°åãƒ»ãƒ¡ãƒ¼ãƒ«ãƒ»é›»è©±ã§æ¤œç´¢">
        <button class="btn" id="custReload">å†èª­è¾¼</button>
        <button class="btn" id="custExport">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      </div>
    </div>
    <div class="table-wrap">
      <table id="custTable">
        <thead><tr>
          <th>é¡§å®¢ID</th><th>æ°å</th><th>é›»è©±</th><th>ãƒ¡ãƒ¼ãƒ«</th><th>ä½æ‰€</th><th>é€£çµ¡æ‰‹æ®µ</th><th>åŒæ„</th><th>æ›´æ–°</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="reservations" class="pane container hidden">
    <div class="section-head">
      <h2>äºˆç´„ç®¡ç†</h2>
      <div class="toolbar">
        <input id="resSearch" placeholder="æ°åãƒ»è»Šç¨®ãƒ»ä½æ‰€ãƒ»ä½œæ¥­ã§æ¤œç´¢">
        <select id="resStatusFilter">
          <option value="">ã™ã¹ã¦</option>
          <option value="æ–°è¦">æ–°è¦</option>
          <option value="ç¢ºèªæ¸ˆ">ç¢ºèªæ¸ˆ</option>
          <option value="æ—¥ç¨‹ç¢ºå®š">æ—¥ç¨‹ç¢ºå®š</option>
          <option value="å‡ºç™º">å‡ºç™º</option>
          <option value="æ–½å·¥ä¸­">æ–½å·¥ä¸­</option>
          <option value="å®Œäº†">å®Œäº†</option>
          <option value="è«‹æ±‚">è«‹æ±‚</option>
          <option value="æœªå">æœªå</option>
          <option value="å…¥é‡‘">å…¥é‡‘</option>
        </select>
        <button class="btn" id="resReload">å†èª­è¾¼</button>
        <button class="btn" id="resExport">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      </div>
    </div>
    <div class="table-wrap">
      <table id="resTable">
        <thead><tr>
          <th>æ¡ˆä»¶ID</th><th>æ—¥ä»˜/æ™‚é–“å¸¯</th><th>é¡§å®¢</th><th>è»Šä¸¡</th><th>ä½æ‰€</th><th>ä½œæ¥­</th><th>å‡ºå¼µè²»</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>æ“ä½œ</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="invoices" class="pane container hidden">
    <div class="section-head">
      <h2>è«‹æ±‚ç®¡ç†</h2>
      <div class="toolbar">
        <input id="invSearch" placeholder="è«‹æ±‚ç•ªå·ãƒ»é¡§å®¢ãƒ»ãƒ¡ãƒ¼ãƒ«ã§æ¤œç´¢">
        <select id="invStatusFilter">
          <option value="">ã™ã¹ã¦</option>
          <option value="æœªå">æœªå</option>
          <option value="éƒ¨åˆ†å…¥é‡‘">éƒ¨åˆ†å…¥é‡‘</option>
          <option value="å…¥é‡‘">å…¥é‡‘</option>
        </select>
        <button class="btn" id="invReload">å†èª­è¾¼</button>
        <button class="btn" id="invExport">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      </div>
    </div>
    <div class="table-wrap">
      <table id="invTable">
        <thead><tr>
          <th>è«‹æ±‚ç•ªå·</th><th>äºˆç´„ID</th><th>é¡§å®¢</th><th>é‡‘é¡</th><th>æœŸæ—¥</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>PDF</th><th>æ“ä½œ</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section id="settings" class="pane container hidden">
    <div class="section-head">
      <h2>è¨­å®š</h2>
      <p>ä¾¡æ ¼ãƒ«ãƒ¼ãƒ«ãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ»ã‚­ãƒ¼ãªã©ã€‚</p>
    </div>
    <div class="grid">
      <div class="col-6 card">
        <h3>ä¾¡æ ¼ãƒ«ãƒ¼ãƒ«ï¼ˆå‚è€ƒï¼‰</h3>
        <div class="muted">ç„¡æ–™åŠå¾„km / 10kmåŠ ç®—é¡ / é«˜é€Ÿãƒ»é§è»Šã®æ‰±ã„ã¯Apps Scriptå´ã§ç®¡ç†ã—ã¾ã™ã€‚</div>
        <div style="margin-top:8px;">
          <button class="btn" id="pullRules">ãƒ«ãƒ¼ãƒ«èª­è¾¼</button>
          <pre id="rulesBox" class="muted" style="white-space:pre-wrap; margin-top:8px;"></pre>
        </div>
      </div>
      <div class="col-6 card">
        <h3>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ»ãƒ•ã‚©ãƒ«ãƒ€</h3>
        <div class="muted">è«‹æ±‚æ›¸PDFã®ãƒ†ãƒ³ãƒ—ãƒ¬IDã€ä¿å­˜ãƒ•ã‚©ãƒ«ãƒ€IDã¯Apps Scriptå´ã§è¨­å®šã—ã¾ã™ã€‚</div>
        <div class="muted" style="margin-top:8px;">å¤‰æ›´ã¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦ã§ã™ã€‚</div>
      </div>
    </div>
  </section>
</main>

<div id="toast" class="toast hidden"></div>

<script>
  // ===== è¨­å®šï¼ˆå·®ã—æ›¿ãˆå¿…é ˆï¼‰ =====
  const SCRIPT_URL = 'https://script.google.com/macros/s/YOUR_DEPLOY_ID/exec';
  const SECRET = 'CHANGE_ME_SECRET'; // Apps Scriptå´ã¨ä¸€è‡´
  // =================================

  // ã‚¿ãƒ–åˆ‡æ›¿
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      const pane = tab.dataset.pane;
      document.querySelectorAll('.pane').forEach(p => p.classList.add('hidden'));
      document.getElementById(pane).classList.remove('hidden');
      if (pane === 'dashboard') loadDashboard();
      if (pane === 'customers') loadCustomers();
      if (pane === 'reservations') loadReservations();
      if (pane === 'invoices') loadInvoices();
    });
  });

  // ãƒˆãƒ¼ã‚¹ãƒˆ
  function toast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.remove('hidden');
    setTimeout(() => t.classList.add('hidden'), 2200);
  }

  // ãƒ•ã‚§ãƒƒãƒå…±é€š
  async function apiGet(params = {}) {
    const url = new URL(SCRIPT_URL);
    Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
    url.searchParams.set('secret', SECRET);
    const res = await fetch(url.toString(), { method: 'GET' });
    return res.json();
  }
  async function apiPost(action, payload = {}) {
    const body = { action, secret: SECRET, ...payload };
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    return res.json();
  }

  // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
  async function loadDashboard() {
    try {
      const json = await apiGet({ action: 'dashboard' });
      document.getElementById('m_today').textContent = json.today || 0;
      document.getElementById('m_new').textContent = json.new || 0;
      document.getElementById('m_uninvoiced').textContent = json.uninvoiced || 0;
      document.getElementById('m_unpaid').textContent = json.unpaid || 0;
      document.getElementById('m_updated').textContent = new Date().toLocaleString('ja-JP');
    } catch (e) {
      toast('ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  // é¡§å®¢ä¸€è¦§
  let customers = [];
  async function loadCustomers() {
    try {
      const json = await apiGet({ action: 'listCustomers' });
      customers = json.items || [];
      renderCustomers(customers);
    } catch (e) {
      toast('é¡§å®¢ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }
  function renderCustomers(items) {
    const q = (document.getElementById('custSearch').value || '').toLowerCase();
    const rows = items.filter(x => {
      const text = [x.name, x.email, x.phone].join(' ').toLowerCase();
      return !q || text.includes(q);
    }).map(x => `
      <tr>
        <td>${x.customer_id}</td>
        <td>${escapeHtml(x.name || '')}</td>
        <td>${escapeHtml(x.phone || '')}</td>
        <td>${escapeHtml(x.email || '')}</td>
        <td>${escapeHtml([x.pref, x.addr1, x.addr2].filter(Boolean).join(' '))}</td>
        <td>${escapeHtml(x.contact_pref || '')}</td>
        <td>${x.consent_policy ? 'âœ…' : 'â€”'}</td>
        <td class="muted">${escapeHtml(x.updated_at || '')}</td>
      </tr>
    `).join('');
    document.querySelector('#custTable tbody').innerHTML = rows || `<tr><td colspan="8" class="muted">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>`;
  }
  document.getElementById('custSearch').addEventListener('input', () => renderCustomers(customers));
  document.getElementById('custReload').addEventListener('click', loadCustomers);
  document.getElementById('custExport').addEventListener('click', () => exportCSV(customers, 'customers.csv'));

  // äºˆç´„ä¸€è¦§
  let reservations = [];
  async function loadReservations() {
    try {
      const json = await apiGet({ action: 'listReservations' });
      reservations = json.items || [];
      renderReservations(reservations);
    } catch (e) {
      toast('äºˆç´„ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }
  function renderReservations(items) {
    const q = (document.getElementById('resSearch').value || '').toLowerCase();
    const f = document.getElementById('resStatusFilter').value || '';
    const rows = items.filter(x => {
      const text = [x.customer_name, x.addr, x.vehicle_model, x.job].join(' ').toLowerCase();
      const statusOk = !f || (x.status || '') === f;
      return (!q || text.includes(q)) && statusOk;
    }).map(x => `
      <tr>
        <td>${x.id}</td>
        <td>${escapeHtml((x.date || '') + ' ' + (x.slot || ''))}</td>
        <td>${escapeHtml(x.customer_name || '')}<div class="muted">${escapeHtml(x.phone || '')}</div></td>
        <td>${escapeHtml([x.vehicle_brand, x.vehicle_model].filter(Boolean).join(' / '))}</td>
        <td>${escapeHtml(x.addr || '')}</td>
        <td>${escapeHtml(x.job || '')}</td>
        <td>${formatJPY(x.travel_fee || 0)}</td>
        <td>${renderStatusChip(x.status)}</td>
        <td>
          <button class="btn" onclick="changeStatus('${x.id}')">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°</button>
          <button class="btn primary" onclick="quickInvoice('${x.id}')">è«‹æ±‚ä½œæˆ</button>
        </td>
      </tr>
    `).join('');
    document.querySelector('#resTable tbody').innerHTML = rows || `<tr><td colspan="9" class="muted">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>`;
  }
  document.getElementById('resSearch').addEventListener('input', () => renderReservations(reservations));
  document.getElementById('resStatusFilter').addEventListener('change', () => renderReservations(reservations));
  document.getElementById('resReload').addEventListener('click', loadReservations);
  document.getElementById('resExport').addEventListener('click', () => exportCSV(reservations, 'reservations.csv'));

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
  async function changeStatus(resId) {
    const next = prompt('æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šç¢ºèªæ¸ˆ, æ—¥ç¨‹ç¢ºå®š, å‡ºç™º, æ–½å·¥ä¸­, å®Œäº†, è«‹æ±‚, æœªå, å…¥é‡‘ï¼‰');
    if (!next) return;
    const json = await apiPost('updateReservationStatus', { id: resId, status: next });
    if (json.ok) { toast('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã—ã¾ã—ãŸ'); loadReservations(); } else { toast('æ›´æ–°å¤±æ•—ï¼š' + (json.error || '')); }
  }

  // ç°¡æ˜“è«‹æ±‚ä½œæˆ
  async function quickInvoice(resId) {
    const parts = Number(prompt('éƒ¨æåˆè¨ˆï¼ˆç¨è¾¼ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç©ºç™½ãªã‚‰0ï¼‰') || '0');
    const discount = Number(prompt('å‰²å¼•ï¼ˆç¨è¾¼ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆç©ºç™½ãªã‚‰0ï¼‰') || '0');
    const json = await apiPost('createInvoice', { reservation_id: resId, parts_total: parts, discount_total: discount });
    if (json.ok) {
      toast('è«‹æ±‚ã‚’ä½œæˆã—ã¾ã—ãŸ');
      loadInvoices();
    } else {
      toast('è«‹æ±‚ä½œæˆå¤±æ•—ï¼š' + (json.error || ''));
    }
  }

  // è«‹æ±‚ä¸€è¦§
  let invoices = [];
  async function loadInvoices() {
    try {
      const json = await apiGet({ action: 'listInvoices' });
      invoices = json.items || [];
      renderInvoices(invoices);
    } catch (e) {
      toast('è«‹æ±‚ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }
  function renderInvoices(items) {
    const q = (document.getElementById('invSearch').value || '').toLowerCase();
    const f = document.getElementById('invStatusFilter').value || '';
    const rows = items.filter(x => {
      const text = [x.number, x.customer_name, x.email].join(' ').toLowerCase();
      const statusOk = !f || (x.status || '') === f;
      return (!q || text.includes(q)) && statusOk;
    }).map(x => `
      <tr>
        <td>${x.number}</td>
        <td>${x.reservation_id || ''}</td>
        <td>${escapeHtml(x.customer_name || '')}<div class="muted">${escapeHtml(x.email || '')}</div></td>
        <td>${formatJPY(x.total || 0)}</td>
        <td>${escapeHtml(x.due_at || '')}</td>
        <td>${escapeHtml(x.status || '')}</td>
        <td>${x.pdf_url ? `<a href="${x.pdf_url}" target="_blank">PDF</a>` : 'â€”'}</td>
        <td>
          <button class="btn" onclick="markPaid('${x.number}')">å…¥é‡‘ç™»éŒ²</button>
        </td>
      </tr>
    `).join('');
    document.querySelector('#invTable tbody').innerHTML = rows || `<tr><td colspan="8" class="muted">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>`;
  }
  document.getElementById('invSearch').addEventListener('input', () => renderInvoices(invoices));
  document.getElementById('invStatusFilter').addEventListener('change', () => renderInvoices(invoices));
  document.getElementById('invReload').addEventListener('click', loadInvoices);
  document.getElementById('invExport').addEventListener('click', () => exportCSV(invoices, 'invoices.csv'));

  async function markPaid(invNumber) {
    const amt = Number(prompt('å…¥é‡‘é‡‘é¡ï¼ˆç¨è¾¼ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„') || '0');
    if (!amt || amt <= 0) return;
    const json = await apiPost('recordPayment', { invoice_number: invNumber, amount: amt });
    if (json.ok) { toast('å…¥é‡‘ã‚’ç™»éŒ²ã—ã¾ã—ãŸ'); loadInvoices(); } else { toast('å…¥é‡‘ç™»éŒ²å¤±æ•—ï¼š' + (json.error || '')); }
  }

  // è¨­å®šãƒ«ãƒ¼ãƒ«è¡¨ç¤º
  document.getElementById('pullRules').addEventListener('click', async () => {
    const json = await apiGet({ action: 'getPricingRules' }).catch(() => ({ ok:false }));
    document.getElementById('rulesBox').textContent = JSON.stringify(json || {}, null, 2);
  });

  // ä¾¿åˆ©é–¢æ•°
  function formatJPY(n) { return 'Â¥' + Number(n || 0).toLocaleString('ja-JP'); }
  function escapeHtml(s) {
    return String(s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
  function exportCSV(items, filename) {
    if (!items || !items.length) { toast('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
    const headers = Object.keys(items[0]);
    const csv = [headers.join(',')].concat(items.map(row =>
      headers.map(h => {
        const v = row[h] == null ? '' : String(row[h]).replace(/"/g,'""');
        return `"${v}"`;
      }).join(',')
    )).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }
  function renderStatusChip(st) {
    const map = {
      'æ–°è¦':'st-new','ç¢ºèªæ¸ˆ':'st-confirmed','æ—¥ç¨‹ç¢ºå®š':'st-confirmed','å‡ºç™º':'st-onroute',
      'æ–½å·¥ä¸­':'st-working','å®Œäº†':'st-done','è«‹æ±‚':'st-invoiced','æœªå':'st-unpaid','å…¥é‡‘':'st-paid'
    };
    const cls = map[st] || 'st-new';
    return `<span class="status ${cls}">${escapeHtml(st || 'æ–°è¦')}</span>`;
  }

  // åˆæœŸãƒ­ãƒ¼ãƒ‰
  loadDashboard();
</script>
</body>
</html>
